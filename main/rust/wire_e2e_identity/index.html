<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Support for obtaining X.509 certificates that bind keys to Wire users."><title>wire_e2e_identity - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="wire_e2e_identity" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.1 (ed61e7d7e 2025-11-07)" data-channel="1.91.1" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js" ><script src="../static.files/storage-e2aeef58.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">Crate wire_e2e_identity</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../wire_e2e_identity/index.html">wire_<wbr>e2e_<wbr>identity</a><span class="version">0.13.0</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section id="rustdoc-toc"><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#overview" title="Overview">Overview</a></li><li><a href="#challenges" title="Challenges">Challenges</a><ul><li><a href="#dpop-challenge-wire-dpop-01" title="DPoP challenge: `wire-dpop-01`">DPoP challenge: <code>wire-dpop-01</code></a></li><li><a href="#oidc-challenge-wire-oidc-01" title="OIDC challenge: `wire-oidc-01`">OIDC challenge: <code>wire-oidc-01</code></a></li><li><a href="#references" title="References">References</a></li></ul></li></ul><h3><a href="#modules">Crate Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#types" title="Type Aliases">Type Aliases</a></li></ul></section><div id="rustdoc-modnav"></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><h1>Crate <span>wire_<wbr>e2e_<wbr>identity</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/wire_e2e_identity/lib.rs.html#1-596">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Support for obtaining X.509 certificates that bind keys to Wire users.</p>
<h2 id="overview"><a class="doc-anchor" href="#overview">§</a>Overview</h2>
<p>On a high level, the process of getting a certificate for a particular Wire client looks like
the following:</p>
<ol>
<li>the client requests an <a href="https://www.rfc-editor.org/rfc/rfc8555.html">ACME</a> server to create a new certificate</li>
<li>the ACME server responds with two challenges, <a href="#dpop-challenge-wire-dpop-01">DPoP</a> and
<a href="#oidc-challenge-wire-oidc-01">OIDC</a></li>
<li>the client completes the DPoP challenge</li>
<li>the client completes the OIDC challenge</li>
<li>the ACME server verifies that both challenges are succesfully completed</li>
<li>the client generates and submits a CSR (certificate signing request) to the ACME server</li>
<li>the ACME server issues a new certificate</li>
</ol>
<p>The client must complete both challenges in order to get a certficate – completing one
challenge is not enough.</p>
<div class="example-wrap"><pre class="language-text"><code>    ┌───────────────────┐    ┌───────────────────┐     ┌───────────────────┐
    │                   │◄───┤                   ├────►│                   │
    │    ACME server    │    │    Wire client    │     │    Wire server    │
    │                   ├───►│                   │◄────┤                   │
    └───────────────────┘    └───────────┬───────┘     └───────────────────┘
                                     ▲   │
                                     │   │             ┌───────────────────┐
                                     │   └────────────►│                   │
                                     │                 │     OIDC IdP      │
                                     └─────────────────┤                   │
                                                       └───────────────────┘</code></pre></div><h2 id="challenges"><a class="doc-anchor" href="#challenges">§</a>Challenges</h2>
<p>The only ACME server implementation supporting the two custom challenge types necessary for the flow is
<a href="https://github.com/smallstep/certificates">step-ca</a>.</p>
<h3 id="dpop-challenge-wire-dpop-01"><a class="doc-anchor" href="#dpop-challenge-wire-dpop-01">§</a>DPoP challenge: <code>wire-dpop-01</code></h3>
<p>This challenge checks whether the data stored with the Wire server (client ID, user name) matches
the data in the device ID that the client submitted when creating the corresponding order.</p>
<p>The challenge requires a Wire server that supports the <code>/clients/{cid}/access-token</code> endpoint.</p>
<p>The flow is roughly as follows:</p>
<ul>
<li>the client requests a fresh nonce from the Wire server via the <code>/clients/token/nonce</code> endpoint</li>
<li>the Wire server responds with a nonce</li>
<li>the client constructs a <a href="https://www.rfc-editor.org/rfc/rfc9449.html">DPoP</a> token
<ul>
<li>the token contains client ID, team and user name</li>
<li>the token is signed by the clients ACME account key (see <a href="https://www.rfc-editor.org/rfc/rfc8555.html#section-3">Terminology</a>)</li>
</ul>
</li>
<li>the client sends the DPoP, together with the nonce, to the Wire server, via the <code>/clients/token/nonce</code> endpoint</li>
<li>the Wire server responds with an access token
<ul>
<li>the access token contains the DPoP provided by the client</li>
<li>the access token is signed by the key whose public part is known to the ACME server</li>
</ul>
</li>
<li>the client sends the Wire access token to the ACME server</li>
<li>the ACME server verifies the challenge by
<ul>
<li>verifying the outer, Wire access token signature</li>
<li>verifying the inner, DPoP token signature</li>
<li>verifying that the DPoP claims match values specified by the challenge</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/smallstep/certificates/blob/2746cd06fb8d68c6720a00e96257038b7e0bbb54/acme/challenge.go#L537">Validation function</a></p>
<h3 id="oidc-challenge-wire-oidc-01"><a class="doc-anchor" href="#oidc-challenge-wire-oidc-01">§</a>OIDC challenge: <code>wire-oidc-01</code></h3>
<p>This challenge checks whether the data stored with the IdP (name, preferred username) matches
the data in the user ID that the client submitted when creating the corresponding order.</p>
<p>The challenge requires an OpenID Connect 1.0 conformant provider with
support for the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ClaimsParameter"><code>claims</code> parameter</a>
in the authorization request.</p>
<p><strong>Important</strong>: the IdP (identity provider) has to support specifying the values of the claims
requested and those values must be present in the returned ID token. In particular, this
mechanism is used by the client to specify values of the <code>keyauth</code> and <code>acme_aud</code> claims.
The client expects the IdP to copy those values to the ID token,
e.g.</p>
<div class="example-wrap"><pre class="language-text"><code> {
  ...
  &quot;name&quot;: &quot;Alice Smith&quot;,
  &quot;acme_aud&quot;: &quot;https://stepca:32791/acme/wire/challenge/vkdvGckMpDfPFDwOYO6LZhSBx2...
  &quot;keyauth&quot;: &quot;MXwp2QZezi1xShr3wjNuqKDmmapvtnxv.StoKb1FuB59XWMLjhsdeU94T95R_AoMP3u2g9HscYog&quot;,
  ...
 }</code></pre></div>
<p>Strictly speaking, this usage of the <code>claims</code> parameter is not according to the OIDC spec as
the provider has no way to check that the specified values match.</p>
<p>The flow makes use of the <a href="https://www.rfc-editor.org/rfc/rfc7636">PKCE extension</a> to the
<a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">OAuth 2.0 Authorization Code flow</a>
and looks roughly as follows:</p>
<ul>
<li>the client generates a PKCE <code>(code challenge, code verifier)</code> pair</li>
<li>the client makes an authorization request to the user’s IdP
<ul>
<li>the request makes use of the <code>claims</code> parameter to instruct the IdP to include <code>keyauth</code> and <code>acme_aud</code> claims
with the provided values in the ID token</li>
<li>the request specifies the <code>redirect_uri</code> parameter which is going to be used by the IdP to redirect the user
back after a login</li>
<li>the request includes the PKCE code challenge value, to be verified later by the IdP when the client requests
an access token</li>
</ul>
</li>
<li>the user is redirected to the IdP’s login page, where authentication is performed</li>
<li>after a successful authentication, the IdP redirects the user back to the OIDC (in this case Wire) client,
returning the authorization code</li>
<li>the client uses the authorization code and the PKCE code verifier to make an access token request to the IdP</li>
<li>the IdP verifies both authorization code and the PKCE code verifier and returns the access token with the ID
token embedded in it; at this point the IdP is no longer needed</li>
<li>the client extracts the ID token from the access token and sends it to the ACME server</li>
<li>the ACME server verifies the challenge by
<ul>
<li>verifying the ID token signature</li>
<li>verifying that the <code>keyauth</code> value matches the key authorization value for this challenge</li>
<li>verifying that the <code>acme_aud</code> value matches the URL of this challenge</li>
<li>verifying that the ID token claims match values specified by the challenge (name, Wire handle)</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/smallstep/certificates/blob/2746cd06fb8d68c6720a00e96257038b7e0bbb54/acme/challenge.go#L407">Validation function</a></p>
<h3 id="references"><a class="doc-anchor" href="#references">§</a>References</h3>
<ul>
<li><a href="https://www.rfc-editor.org/rfc/rfc7519">RFC7519: JSON Web Token (JWT)</a></li>
<li><a href="https://www.ietf.org/rfc/rfc8725">RFC8725: JSON Web Token Best Current Practices</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc7636">RFC7636: Proof Key for Code Exchange by OAuth Public Clients</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc8555">RFC8555: Automatic Certificate Management Environment (ACME)</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc9449">RFC9449: OAuth 2.0 Demonstrating Proof of Possession (DPoP)</a></li>
<li><a href="https://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect Core 1.0</a></li>
</ul>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><dl class="item-table"><dt><a class="mod" href="acme/index.html" title="mod wire_e2e_identity::acme">acme</a></dt><dt><a class="mod" href="prelude/index.html" title="mod wire_e2e_identity::prelude">prelude</a></dt></dl><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.RustyE2eIdentity.html" title="struct wire_e2e_identity::RustyE2eIdentity">Rusty<wbr>E2eIdentity</a></dt></dl><h2 id="types" class="section-header">Type Aliases<a href="#types" class="anchor">§</a></h2><dl class="item-table"><dt><a class="type" href="type.Json.html" title="type wire_e2e_identity::Json">Json</a></dt></dl></section></div></main></body></html>