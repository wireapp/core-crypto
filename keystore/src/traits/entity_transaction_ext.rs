use std::borrow::Borrow;

use async_trait::async_trait;

use crate::{
    CryptoKeystoreResult,
    traits::{Entity, KeyType},
};

/// Extend an [`Entity`] with db-mutating operations which can be performed when provided with a transaction.
#[cfg_attr(target_family = "wasm", async_trait(?Send))]
#[cfg_attr(not(target_family = "wasm"), async_trait)]
pub trait EntityTransactionExt<'a>: Entity<ConnectionType = crate::connection::KeystoreDatabaseConnection> {
    type Transaction: 'a;

    /// Adjust self before saving.
    ///
    /// This will be called by the transaction's implementation of `save_mut` and should not be called
    /// as part of the `save` implementation.
    async fn pre_save(&mut self) -> CryptoKeystoreResult<Self::AutoGeneratedFields> {
        Ok(Default::default())
    }

    /// Use the transaction's interface to save this entity to the database
    async fn save(&self, tx: &Self::Transaction) -> CryptoKeystoreResult<()>;

    /// Use the transaction's interface to count the number of entities of this type in the database.
    async fn count(tx: &Self::Transaction) -> CryptoKeystoreResult<u32>;

    /// Use the transaction's inteface to delete this entity from the database.
    ///
    /// Returns `true` if at least one entity was deleted, or `false` if the id was not found in the database.
    ///
    /// For entites whose primary key has a distinct borrowed type, it is best to implement this as a direct passthrough:
    ///
    /// ```rust,ignore
    /// async fn delete(tx: &Self::Transaction, key: &Self::PrimaryKey) -> CoreCryptoKeystoreResult<bool> {
    ///     <Self as EntityTransactionDeleteBorrowed<'a>>::delete_borrowed(tx, id).await
    /// }
    /// ```
    async fn delete(tx: &Self::Transaction, id: &<Self as Entity>::PrimaryKey) -> CryptoKeystoreResult<bool>;
}

/// Extend an [`Entity`] with db-mutating operations which can be performed when provided with a transaction.
#[cfg_attr(target_family = "wasm", async_trait(?Send))]
#[cfg_attr(not(target_family = "wasm"), async_trait)]
pub trait EntityTransactionDeleteBorrowed<'a>: EntityTransactionExt<'a> {
    /// Delete an entity by a borrowed form of its primary key.
    ///
    /// The type signature here is somewhat complicated, but it breaks down simply: if our primary key is something
    /// like `Vec<u8>`, we want to be able to use this method even if what we have on hand is `&[u8]`.
    async fn delete_borrowed<Q>(
        tx: &<Self as EntityTransactionExt<'a>>::Transaction,
        id: &Q,
    ) -> CryptoKeystoreResult<bool>
    where
        Self::PrimaryKey: Borrow<Q>,
        Q: KeyType;
}
