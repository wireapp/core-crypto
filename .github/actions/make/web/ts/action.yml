name: Fetch or make the web bindings files and wrappers
inputs:
  gh-token:
    required: true

runs:
  using: composite

  steps:
      - name: Set MAKE
        uses: ./.github/actions/make/set-make-executable

      - name: Install wasm-bindgen-cli
        uses: jetli/wasm-bindgen-action@v0.2.0

      # ensure bun deps are installed freshly before any command using bun is invoked
      - name: install bun deps
        run: |
          $MAKE bun-deps
        shell: bash -euo pipefail {0}

      - name: build wasm
        uses: ./.github/actions/make
        with:
          key: wasm-build
          make-rule:  wasm-build
          target-path: |
            crypto-ffi/bindings/js/src/autogenerated/core_crypto_ffi.ts
            crypto-ffi/bindings/js/src/autogenerated/wasm-bindgen/index_bg.wasm.d.ts
            crypto-ffi/bindings/js/src/autogenerated/wasm-bindgen/index_bg.wasm
            crypto-ffi/bindings/js/src/autogenerated/wasm-bindgen/index.js
            crypto-ffi/bindings/js/src/autogenerated/wasm-bindgen/index.d.ts
          gh-token: ${{ inputs.gh-token }}
          uses-rust: true
          rust-target: wasm32-unknown-unknown


      - name: transpile js to ts
        uses: ./.github/actions/make
        with:
          key: ts
          make-rule: ts
          target-path: |
            crypto-ffi/bindings/js/out/corecrypto.d.ts
            crypto-ffi/bindings/js/out/corecrypto.js
            crypto-ffi/bindings/js/out/autogenerated/wasm-bindgen/index_bg.wasm
            crypto-ffi/bindings/js/out/autogenerated/wasm-bindgen/index_bg.wasm.d.ts
          gh-token: ${{ inputs.gh-token }}
