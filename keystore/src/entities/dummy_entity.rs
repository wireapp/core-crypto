use crate::{CryptoKeystoreResult, Entity, EntityBase, UniqueEntity};

#[derive(Debug, Eq, Clone, PartialEq, serde::Serialize, serde::Deserialize)]
pub struct DummyStoreValue;

impl EntityBase for DummyStoreValue {
    type ConnectionType = crate::connection::KeystoreDatabaseConnection;
    type AutoGeneratedFields = ();
    const COLLECTION_NAME: &'static str = "";

    fn to_transaction_entity(self) -> crate::transaction::dynamic_dispatch::Entity {
        unimplemented!("Not implemented")
    }
}

impl UniqueEntity for DummyStoreValue {
    const KEY: <Self as Entity>::PrimaryKey = &[0];
}

#[cfg_attr(target_family = "wasm", async_trait::async_trait(?Send))]
#[cfg_attr(not(target_family = "wasm"), async_trait::async_trait)]
impl Entity for DummyStoreValue {
    /// Each distinct [`PrimaryKey`] uniquely identifies either 0 or 1 instance.
    ///
    /// This constraint should be enforced at the DB level.
    type PrimaryKey = &'static [u8];

    /// Get this entity's primary key.
    fn primary_key(&self) -> Self::PrimaryKey {
        <Self as UniqueEntity>::KEY
    }

    /// Get an entity by its primary key.
    ///
    /// The type signature here is somewhat complicated, but it breaks down simply: if our primary key is something
    /// like `Vec<u8>`, we want to be able to use this method even if what we have on hand is `&[u8]`.
    async fn get(_conn: &mut Self::ConnectionType, key: &&'static [u8]) -> CryptoKeystoreResult<Option<Self>> {
        Ok((*key == Self::KEY).then_some(Self))
    }

    /// Count the number of entities of this type in the database.
    async fn count(_conn: &mut Self::ConnectionType) -> CryptoKeystoreResult<u32> {
        Ok(1)
    }

    /// Retrieve all entities of this type from the database.
    async fn load_all(_conn: &mut Self::ConnectionType) -> CryptoKeystoreResult<Vec<Self>> {
        Ok(vec![Self])
    }
}

#[derive(Debug, Clone, PartialEq, Eq)]
pub struct DummyValue(Vec<u8>);

impl From<&str> for DummyValue {
    fn from(id: &str) -> Self {
        DummyValue(format!("dummy value {id}").into_bytes())
    }
}
