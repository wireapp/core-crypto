name: publish jvm packages

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}-publish-jvm"

on:
  workflow_call:
    secrets:
      SONATYPE_USERNAME:
        required: true
      SONATYPE_PASSWORD:
        required: true
      PGP_KEY_ID:
        required: true
      PGP_SIGNING_KEY:
        required: true
      PGP_PASSPHRASE:
        required: true
    inputs:
        prepare:
          description: "If true, stage and validate artifacts."
          required: false
          type: boolean
          default: false
        release:
          description: "If true, release staged artifacts."
          required: false
          type: boolean
          default: false

env:
  RELEASE: 1

jobs:
  jvm:
    if: github.repository == 'wireapp/core-crypto'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: set up jdk 17
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: "adopt"

      - name: download bindings artifact
        uses: ./.github/actions/make/bindings-kotlin-jvm
        with:
          gh-token: ${{ secrets.GITHUB_TOKEN }}

      - name: gradle setup
        uses: gradle/actions/setup-gradle@v5

      - name: validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v5

      - name: download jvm bindings
        uses: ./.github/actions/make/bindings-kotlin-jvm
        with:
          gh-token: ${{ secrets.GITHUB_TOKEN }}

      - name: download x86_64 linux artifact
        uses: ./.github/actions/make/jvm
        with:
          gh-token: ${{ secrets.GITHUB_TOKEN }}

      # The specific jvm action uses `uname -s` to determine which `jvm` make rule to call.
      # Because this workflow runs on ubuntu, we're using the generic action
      - name: download aarch64 apple darwin artifact
        uses: ./.github/actions/make
        with:
          key: jvm-darwin
          make-rule: jvm-darwin
          target-path: target/aarch64-apple-darwin/release/libcore_crypto_ffi.dylib
          gh-token: ${{ secrets.GITHUB_TOKEN }}

      - name: zip package
        run: |
          zip -r jvm.zip \
          crypto-ffi/bindings/jvm/src/main/uniffi/com/wire/crypto/core_crypto_ffi.kt \
          target/aarch64-apple-darwin/release/libcore_crypto_ffi.dylib \
          target/x86_64-unknown-linux-gnu/release/libcore_crypto_ffi.so

      - name: upload package
        uses: softprops/action-gh-release@v2
        with:
            files: jvm.zip
            fail_on_unmatched_files: true

      - name: stage artifact
        if: ${{ inputs.prepare == true }}
        run: |
          cd crypto-ffi/bindings
          ./gradlew :jvm:publishToSonatype closeSonatypeStagingRepository --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.PGP_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.PGP_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.PGP_PASSPHRASE }}

      - name: release artifact
        if: ${{ inputs.release == true }}
        run: |
          cd crypto-ffi/bindings
          ./gradlew :jvm:releaseSonatypeStagingRepository --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.PGP_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.PGP_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.PGP_PASSPHRASE }}

      - name: delete package from gh release
        if: ${{ inputs.release == true }}
        run: gh release delete-asset $GITHUB_REF_NAME "jvm.zip" --yes
        env:
          GH_TOKEN: ${{ github.token }}
