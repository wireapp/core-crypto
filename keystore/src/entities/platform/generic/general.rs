use async_trait::async_trait;
use rusqlite::Row;

use super::{count_helper, get_helper, load_all_helper};
use crate::{
    CryptoKeystoreResult, Entity, EntityBase, UniqueEntity, connection::KeystoreDatabaseConnection,
    entities::ConsumerData,
};

#[async_trait::async_trait]
impl EntityBase for ConsumerData {
    type ConnectionType = KeystoreDatabaseConnection;
    type AutoGeneratedFields = ();
    const COLLECTION_NAME: &'static str = "consumer_data";

    fn to_transaction_entity(self) -> crate::transaction::dynamic_dispatch::Entity {
        crate::transaction::dynamic_dispatch::Entity::ConsumerData(self)
    }
}

impl ConsumerData {
    fn from_row(row: &Row<'_>) -> rusqlite::Result<Self> {
        let content = row.get("content")?;
        Ok(Self { content })
    }
}

#[async_trait]
impl Entity for ConsumerData {
    type PrimaryKey = u32;

    fn primary_key(&self) -> Self::PrimaryKey {
        <Self as UniqueEntity>::KEY
    }

    /// Get an entity by its primary key.
    ///
    /// For entites whose primary key has a distinct borrowed type, it is best to implement this as a direct passthrough:
    ///
    /// ```rust,ignore
    /// async fn get(conn: &mut Self::ConnectionType, key: &Self::PrimaryKey) -> CoreCryptoKeystoreResult<Option<Self>> {
    ///     <Self as EntityGetBorrowed>::get_borrowed(conn, key).await
    /// }
    /// ```
    async fn get(conn: &mut Self::ConnectionType, key: &Self::PrimaryKey) -> CryptoKeystoreResult<Option<Self>> {
        get_helper(conn, "id", *key, Self::from_row).await
    }

    /// Count the number of entities of this type in the database.
    async fn count(conn: &mut Self::ConnectionType) -> CryptoKeystoreResult<u32> {
        count_helper::<Self>(conn).await
    }

    /// Retrieve all entities of this type from the database.
    async fn load_all(conn: &mut Self::ConnectionType) -> CryptoKeystoreResult<Vec<Self>> {
        load_all_helper(conn, Self::from_row).await
    }
}

#[async_trait::async_trait]
impl UniqueEntity for ConsumerData {
    const KEY: u32 = 0;
}
